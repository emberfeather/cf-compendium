<?xml version="1.0"?>
<project name="cf-compendium" default="minify" basedir=".">
	<!-- Include the property files -->
	<property file="${basedir}/user.properties"/>
	<property file="${basedir}/project.properties"/>
	
	<target name="minify" depends="prepare" description="Minify the CSS and JS files">
		<echo message="Starting: CSS and JS minification"/>
		
		<!-- Use the jar to minify the css and js files -->
		<apply executable="java" parallel="false" dest="${basedir}/${project.name}/script">
			<fileset dir="${basedir}/${project.name}/script" includes="**/*.js" excludes="**/*-min.js" />
			<arg line="-jar"/>
			<arg path="${basedir}/${build.dist}/lib/yuicompressor-2.4.2/yuicompressor.jar" />
			<arg line="-v"/>
			<srcfile/>
			<arg line="-o"/>
			<mapper type="glob" from="*.js" to="*-min.js"/>
			<targetfile/>
		</apply>
		
		<apply executable="java" parallel="false" dest="${basedir}/${project.name}/style">
			<fileset dir="${basedir}/${project.name}/style" includes="**/*.css" excludes="**/*-min.css" />
			<arg line="-jar"/>
			<arg path="${basedir}/${build.dist}/lib/yuicompressor-2.4.2/yuicompressor.jar" />
			<arg line="-v"/>
			<srcfile/>
			<arg line="-o"/>
			<mapper type="glob" from="*.css" to="*-min.css"/>
			<targetfile/>
		</apply>
		
		<echo message="Finished: CSS and JS minification"/>
	</target>
	
	<target name="prepare">
		<echo message="Starting: Environment Preparation"/>
		
		<!-- Define log file -->
		<record name="${basedir}${build.dist}/logs/${build.logfile}"/>
		
		<!-- Create the time stamp -->
		<tstamp>
			<format property="build.date" pattern="MM/dd/yy hh:mmaa"/>
		</tstamp>
		
		<echo message="Finished: Environment Preparation"/>
	</target>
	
	<target name="prepareSVN" depends="prepare">
		<echo message="Starting: SVN Preparation"/>
		
		<path id="svn.classpath">
			<pathelement location="${basedir}/dist/lib/svnant-1.3.0/svnant.jar" />
			<pathelement location="${basedir}/dist/lib/svnant-1.3.0/svnClientAdapter.jar"/>
			<pathelement location="${basedir}/dist/lib/svnant-1.3.0/svnjavahl.jar"/>
			<pathelement location="${basedir}/dist/lib/svnant-1.3.0/svnkit.jar"/>
			<pathelement location="${basedir}/dist/lib/svnant-1.3.0/ganymed.jar"/>
		</path>
		
		<!-- Load ANT tasks -->
		<typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="svn.classpath"/>
		
		<!-- Create the time stamp -->
		<tstamp>
			<format property="svn.log.startDate" pattern="yyyy-MM-dd" offset="-5" unit="year" />
			<format property="svn.log.endDate" pattern="yyyy-MM-dd" offset="1" unit="day"/>
		</tstamp>
		
		<!-- Get the SVN information -->
		<input addproperty="svn.username" message="SVN Username" />
		<input addproperty="svn.password" message="SVN Password" />
		
		<echo message="Finished: SVN Preparation"/>
	</target>
	
	<target name="statSVN" depends="svnLog" description="Generates statistics from the repository">
		<echo message="Starting: SVN Statistics"/>
		
		<taskdef name="statsvn" classname="net.sf.statsvn.ant.StatSvnTask" classpath="${basedir}/dist/lib/statSVN-0.5.0/statsvn.jar" />
		
		<statsvn
			path="${basedir}"
			log="${basedir}${build.dist}/logs/${svn.commit.log}"
			outputDir="${basedir}${build.dist}/stats"
			title="${project.fullname}"
			include="**/*.cfc;**/*.cfm;**/*.js;**/*.css;**/*.xml;**/*.properties"
			username="${svn.username}"
			password="${svn.password}" />
		
		<echo message="Finished: SVN Statistics at ${basedir}${build.dist}/stats"/>
	</target>
	
	<target name="svnCommit" depends="prepareSVN,minify" description="Commits the code to the repository">
		<echo message="Starting: SVN Commit"/>
		
		<input addproperty="svn.message" message="Commit Message" />
		
		<svn username="${svn.username}" password="${svn.password}" javahl="${svn.javahl}" svnkit="${svn.svnkit}">
			<commit dir="${basedir}" recurse="true" message="${svn.message}"/>
		</svn>
		
		<echo message="Finished: SVN Commit"/>
	</target>
	
	<target name="svnLog" depends="prepareSVN" description="Generates logs from the repository">
		<echo message="Starting: SVN Log"/>
		
		<exec executable="svn" output="${basedir}${build.dist}/logs/${svn.commit.log}">
			<arg value="log"/>
			<arg value="-v"/>
			<arg value="--xml"/>
			<arg value="--username"/>
			<arg value="${svn.username}"/>
			<arg value="--password"/>
			<arg value="${svn.password}"/>
			<arg value="-r"/>
			<arg value="{${svn.log.startDate}}:{${svn.log.endDate}}"/>
			<arg value="${basedir}"/>
		</exec>
		
		<echo message="Finished: SVN Log at ${basedir}${build.dist}/logs/${svn.commit.log}"/>
	</target>
	
	<target name="svnUpdate" depends="prepareSVN" description="Updates the code from the repository">
		<echo message="Starting: SVN Update"/>
		
		<svn username="${svn.username}" password="${svn.password}" javahl="${svn.javahl}" svnkit="${svn.svnkit}">
			<update dir="${basedir}" recurse="true"/>
		</svn>
		
		<echo message="Finished: SVN Update"/>
	</target>
	
	<target name="test" depends="prepare" description="Runs the Unit Tests">
		<echo message="Starting: Unit Tests"/>
		
		<taskdef name="mxunittask" classname="org.mxunit.ant.MXUnitAntTask" classpath="${basedir}/mxunit/ant/lib/mxunit-ant-java5.jar" />
		
		<mxunittask server="${mxunit.host}" port="${mxunit.port}" outputdir="${basedir}${build.dist}/unit" defaultrunner="${mxunit.defaultrunner}" verbose="${general.verbose}" haltonerror="true">
			<directory path="${basedir}/test" componentPath="${mxunit.componentpath}" recurse="true" />
		</mxunittask>
		
		<echo message="Finished: Unit Tests"/>
	</target>
</project>